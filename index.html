<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ピーキング戦略（前日まで）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; background: #f4f4f4; padding: 20px; }
    .container { background: #fff; padding: 20px; border-radius: 10px; max-width: 900px; margin: auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 20px; padding: 10px; font-size: 1em; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background-color: #eee; }
    .day-block { margin-bottom: 40px; }
    .input-error { border: 2px solid red; }
    @media print {
      button { display: none; }
      body { -webkit-print-color-adjust: exact; }
      table { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ピーキング戦略（前日まで）</h1>

  <button onclick="window.print()">PDFとして保存 / 印刷</button>

  <label>体重（kg）</label>
  <input id="weight" type="number" placeholder="例：70" />

  <label>体脂肪率（％</label>
  <input id="bodyfat" type="number" placeholder="例：15" />

  <label>TDEE（1日の消費カロリー）</label>
  <input id="tdee" type="number" placeholder="例：2500" />

  <label>ピーキング期間</label>
  <select id="days">
    <option value="3">3日間</option>
    <option value="5">5日間</option>
    <option value="7" selected>7日間</option>
  </select>

  <label>食事回数（3以上）</label>
  <select id="mealCount">
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5" selected>5</option>
    <option value="6">6</option>
  </select>

  <label>起床時間</label>
  <input id="wakeTime" type="time" />

  <label>水分感受性</label>
  <select id="waterSensitivity">
    <option value="low">低</option>
    <option value="medium" selected>中</option>
    <option value="high">高</option>
  </select>

  <label>塩分感受性</label>
  <select id="saltSensitivity">
    <option value="low">低</option>
    <option value="medium" selected>中</option>
    <option value="high">高</option>
  </select>

  <label>炭水化物感受性</label>
  <select id="carbSensitivity">
    <option value="low">低</option>
    <option value="medium" selected>中</option>
    <option value="high">高</option>
  </select>

  <button onclick="displayFullSchedule()">全日スケジュールを表示</button>

  <div id="inputError" style="color: red; margin-top: 10px;"></div>
  <div id="output"></div>
</div>

<script>
function displayFullSchedule() {
  const weightInput = document.getElementById("weight");
  const tdeeInput = document.getElementById("tdee");
  const mealInput = document.getElementById("mealCount");
  const wakeInput = document.getElementById("wakeTime");
  const bodyfatInput = document.getElementById("bodyfat");
  const errorOutput = document.getElementById("inputError");

  const weight = parseFloat(weightInput.value);
  const bodyfat = parseFloat(bodyfatInput.value);
  const leanWeight = weight * (1 - bodyfat / 100);
  const tdee = parseFloat(tdeeInput.value);
  const meals = parseInt(mealInput.value);
  const wake = wakeInput.value;

  let errorMessages = [];
  const inputsToValidate = [weightInput, bodyfatInput, tdeeInput, mealInput, wakeInput];
  inputsToValidate.forEach(el => el.classList.remove("input-error"));

  if (isNaN(weight) || weight < 30 || weight > 200) {
    weightInput.classList.add("input-error");
    errorMessages.push("体重（30〜200kg）を入力してください。");
  }
  if (isNaN(bodyfat) || bodyfat < 3 || bodyfat > 50) {
    bodyfatInput.classList.add("input-error");
    errorMessages.push("体脂肪率（3〜50％）を入力してください。");
  }
  if (isNaN(tdee) || tdee < 1000 || tdee > 6000) {
    tdeeInput.classList.add("input-error");
    errorMessages.push("TDEE（1000〜6000）を入力してください。");
  }
  if (isNaN(meals) || meals < 3) {
    mealInput.classList.add("input-error");
    errorMessages.push("食事回数は3以上で入力してください。");
  }
  if (!wake) {
    wakeInput.classList.add("input-error");
    errorMessages.push("起床時間を入力してください。");
  }

  if (errorMessages.length > 0) {
    errorOutput.innerHTML = errorMessages.join("<br>");
    return;
  } else {
    errorOutput.innerHTML = "";
  }

  // ▼ 体脂肪率ベースでPFC決定
  const carbSens = document.getElementById("carbSensitivity").value;
  let proteinRate = 0.30 + (bodyfat / 100) * 0.15;  // 上限0.45
  let fatRate = 0.25 - (bodyfat / 100) * 0.05;      // 下限0.20
  let carbRate = 1 - proteinRate - fatRate;

  // 感受性調整
  const carbAdjust = { low: -0.05, medium: 0.0, high: 0.05 }[carbSens];
  carbRate = Math.min(Math.max(carbRate + carbAdjust, 0.3), 0.6);
  proteinRate = Math.min(Math.max(proteinRate, 0.30), 0.50);
  fatRate = 1 - proteinRate - carbRate;

  const days = parseInt(document.getElementById("days").value);
  const waterSens = document.getElementById("waterSensitivity").value;
  const saltSens = document.getElementById("saltSensitivity").value;
  const [wakeH, wakeM] = wake.split(":").map(Number);
  const output = document.getElementById("output");

  const plan = {
    3: [0.8, 0.6, 1.2],
    5: [0.8, 0.7, 0.6, 1.0, 1.2],
    7: [0.9, 0.8, 0.7, 0.6, 1.0, 1.1, 1.2]
  }[days].map((rate, i) => ({
    day: i + 1,
    tdeeRatio: rate,
    calories: Math.round(rate * tdee),
    baseWater: (6 - i * 0.5),
    baseSalt: Math.max(16 - i * 2, 3)
  }));

  const adjust = (base, sens) => base * ({ low: 1.2, medium: 1.0, high: 0.8 }[sens]);

  output.innerHTML = "";
  const dayMinutes = 14 * 60;
  const interval = Math.floor(dayMinutes / (meals - 1));

  plan.forEach(p => {
    const protein = Math.round((p.calories * proteinRate) / 4);
    const fat = Math.round((p.calories * fatRate) / 9);
    const carb = Math.round((p.calories * carbRate) / 4);
    const pMeal = Math.round(protein / meals);
    const fMeal = Math.round(fat / meals);
    const cMeal = Math.round(carb / meals);
    const water = adjust(p.baseWater, waterSens).toFixed(1);
    const salt = Math.round(adjust(p.baseSalt, saltSens));

    let time = new Date(0, 0, 0, wakeH, wakeM);
    let rows = "";

    for (let i = 0; i < meals; i++) {
      const t = time.toTimeString().slice(0, 5);
      rows += `<tr><td>${t}</td><td>食事${i + 1}</td><td>${pMeal}g</td><td>${fMeal}g</td><td>${cMeal}g</td></tr>`;
      time.setMinutes(time.getMinutes() + interval);
    }

    output.innerHTML += `
      <div class="day-block">
        <h3>Day ${p.day}（${p.calories} kcal / 水分 ${water}L / 塩分 ${salt}g）</h3>
        <table>
          <thead><tr><th>時間</th><th>内容</th><th>P</th><th>F</th><th>C</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  });
}
</script>