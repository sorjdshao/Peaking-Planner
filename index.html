<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>16週PR更新トレーニングプランナー</title>
  <style>
    body { font-family: sans-serif; background: #f5f5f5; padding: 10px; font-size: 1rem; }
    .container { background: white; border-radius: 10px; padding: 15px; max-width: 1000px; margin: auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    table { width: 100%; display: block; overflow-x: auto; font-size: 0.9rem; margin-top: 10px; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background-color: #eee; }
    input[type="number"], select { width: 100%; padding: 10px; font-size: 1rem; box-sizing: border-box; margin-bottom: 10px; }
    .btn { margin-top: 10px; padding: 15px; font-size: 1rem; background: #4CAF50; color: white; border: none; width: 100%; cursor: pointer; border-radius: 5px; }
    details { margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; padding: 5px; background-color: #fafafa; }
    summary { font-weight: bold; cursor: pointer; padding: 5px; }
    .unit-label { display: inline-block; margin-left: 4px; color: #888; }
  </style>
</head>
<body>
  <div class="container">
    <h2>16週PR更新トレーニングプランナー</h2>
    <label>現在のPR（kg）：<input type="number" id="currentPR" value="100"></label>
    <label>Week16の目標PR％：
      <select id="finalPRRate">
        <option value="1.03">103%</option>
        <option value="1.05" selected>105%</option>
        <option value="1.075">107.5%</option>
      </select>
    </label>
    <label>週あたりのトレーニング日数：
      <select id="daysPerWeek">
        <option value="3">3日</option>
        <option value="4">4日</option>
        <option value="5" selected>5日</option>
        <option value="6">6日</option>
        <option value="7">7日</option>
      </select>
    </label>
    <label>週のトップセット実施回数：
      <select id="topSetPerWeek">
        <option value="3">3回</option>
        <option value="4" selected>4回</option>
        <option value="5">5回</option>
      </select>
    </label>
    <!-- 修正済みのボタン -->
    <button class="btn" onclick="saveInputs(); generateScheduleTables();">計算する</button>
    <div id="weeksContainer"></div>
  </div>

  <script>
    const weeksContainer = document.getElementById("weeksContainer");
    let completionData = JSON.parse(localStorage.getItem("completionData") || '{}');

    function saveCompletionData() {
      localStorage.setItem("completionData", JSON.stringify(completionData));
    }

    function saveInputs() {
      localStorage.setItem("formValues", JSON.stringify({
        currentPR: document.getElementById("currentPR").value,
        finalPRRate: document.getElementById("finalPRRate").value,
        daysPerWeek: document.getElementById("daysPerWeek").value,
        topSetPerWeek: document.getElementById("topSetPerWeek").value
      }));
    }

    function loadInputs() {
      const data = JSON.parse(localStorage.getItem("formValues"));
      if (!data) return;
      document.getElementById("currentPR").value = data.currentPR;
      document.getElementById("finalPRRate").value = data.finalPRRate;
      document.getElementById("daysPerWeek").value = data.daysPerWeek;
      document.getElementById("topSetPerWeek").value = data.topSetPerWeek;
    }

    function getIntensityRange(week) {
      const base = 70;
      const increment = (85 - base) / 15;
      return Array.from({ length: 5 }, (_, i) => (base + (week - 1) * increment).toFixed(1));
    }

    function getProgressedPR(currentPR, week, finalRate) {
      const startRate = 0.92;
      const midRate = 1.00;
      const endRate = finalRate;
      if (week <= 12) {
        const step = (midRate - startRate) / 11;
        return currentPR * (startRate + step * (week - 1));
      } else {
        const step = (endRate - midRate) / 4;
        return currentPR * (midRate + step * (week - 13));
      }
    }

    function generateScheduleTables() {
      weeksContainer.innerHTML = "";
      const currentPR = parseFloat(document.getElementById("currentPR").value);
      const finalRate = parseFloat(document.getElementById("finalPRRate").value);
      const daysPerWeek = parseInt(document.getElementById("daysPerWeek").value);
      const topSetCount = parseInt(document.getElementById("topSetPerWeek").value);
      const dayVolume = { 3: [6, 7, 6], 4: [6, 6, 6, 5], 5: [5, 6, 5, 5, 5], 6: [5, 5, 5, 5, 5, 4], 7: [5, 5, 5, 5, 4, 4, 3] }[daysPerWeek];

      for (let week = 1; week <= 16; week++) {
        const isDeload = [9, 13, 17].includes(week);
        const isPRChallenge = [8, 12, 16].includes(week);
        const progressedPR = getProgressedPR(currentPR, week, finalRate).toFixed(1);

        const details = document.createElement("details");
        const summary = document.createElement("summary");
        summary.textContent = `Week ${week}（PR目標: ${progressedPR}kg）` +
          (isDeload ? "（Deload Week）" : "") +
          (isPRChallenge ? " ★PRチャレンジ週★" : "");
        details.appendChild(summary);

        const topSetDays = Array.from({ length: daysPerWeek }, (_, i) => i);
        const selectedDays = topSetDays.sort(() => Math.random() - 0.5).slice(0, topSetCount);

        for (let day = 0; day < daysPerWeek; day++) {
          const table = document.createElement("table");
          const caption = document.createElement("caption");
          caption.textContent = `Day ${day + 1}`;
          table.appendChild(caption);
          table.innerHTML += `<tr><th>セット名</th><th>重量(kg)</th><th>Reps</th><th>完遂</th></tr>`;

          let setIndexOffset = 0;

          if (!isDeload && selectedDays.includes(day)) {
            const topInput = document.createElement("input");
            topInput.type = "number";
            topInput.placeholder = "トップセット重量";

            const rows = [
              { label: "① トップ-10kg", offset: -10 },
              { label: "② トップ-5kg", offset: -5 },
              { label: "③ トップセット", offset: 0, manual: true }
            ];

            rows.forEach(({ label, offset, manual }) => {
              const row = document.createElement("tr");
              row.innerHTML = `<td>${label}</td>`;
              const weightInput = manual ? topInput : document.createElement("input");
              weightInput.type = "number";
              if (!manual) weightInput.readOnly = true;
              const td = document.createElement("td");
              td.appendChild(weightInput);
              td.innerHTML += " <span class='unit-label'>kg</span>";
              row.appendChild(td);
              row.innerHTML += `<td>1</td><td><input type='checkbox'></td>`;
              table.appendChild(row);

              if (!manual) {
                topInput.addEventListener("input", () => {
                  const val = parseFloat(topInput.value);
                  if (!isNaN(val)) weightInput.value = (val + offset).toFixed(1);
                });
              }
            });

            setIndexOffset = 3;
          }

          const intensities = getIntensityRange(week);
          const repRanges = ["6〜8回", "8〜10回", "10〜12回", "12〜15回", "15〜20回"];
          const normalSetCount = dayVolume[day];

          for (let i = 0; i < normalSetCount; i++) {
            const intensity = parseFloat(intensities[i]);
            const adjustedIntensity = isDeload ? (intensity * 0.8).toFixed(1) : intensity.toFixed(1);
            const repRange = isDeload
              ? repRanges[Math.min(i + 1, repRanges.length - 1)]
              : repRanges[i];

            const row = document.createElement("tr");
            row.innerHTML = `<td>セット${i + 4}（${adjustedIntensity}%）</td>`;
            const weightInput = document.createElement("input");
            weightInput.type = "number";
            weightInput.value = (progressedPR * (adjustedIntensity / 100)).toFixed(1);
            const tdWeight = document.createElement("td");
            tdWeight.appendChild(weightInput);
            tdWeight.innerHTML += " <span class='unit-label'>kg</span>";
            row.appendChild(tdWeight);
            row.innerHTML += `<td>${repRange}</td><td><input type="checkbox"></td>`;
            table.appendChild(row);
          }

          details.appendChild(table);
        }

        weeksContainer.appendChild(details);
      }
    }

    window.onload = () => {
      loadInputs();
      generateScheduleTables();
    };
  </script>
</body>
</html>