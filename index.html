
<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<title>ピーキング戦略完全版</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<style>
    body { font-family: sans-serif; background: #f4f4f4; padding: 20px; }
    .container { background: #fff; padding: 20px; border-radius: 10px; max-width: 900px; margin: auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 20px; padding: 10px; font-size: 1em; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th[title] { cursor: help; }
    th { background-color: #eee; }
    @media print {
      body { -webkit-print-color-adjust: exact; }
      table { page-break-inside: avoid; }
    }
  
#adjustSummary { margin-top: 20px; padding: 10px; background: #e7f3fe; border-left: 5px solid #2196F3; }
#output { margin-top: 20px; }
button:hover { background: #45a049; }
h2 { color: #333; margin-top: 40px; }
@media (max-width: 600px) {
  input, select, button { font-size: 1em; }
  h1 { font-size: 1.5em; }
}
</style>
</head>
<body>
<div class="container">
<h1>ピーキング戦略完全版</h1>
<button onclick="window.print()">PDFとして保存 / 印刷</button>
<label>体重（kg）</label>
<input id="weight" placeholder="例：70" type="number"/>
<label>TDEE（1日の消費カロリー）</label>
<input id="tdee" oninput="updatePFCfromTDEE()" placeholder="例：2500" type="number"/>
<label>体脂肪率（％）</label>
<input id="bodyfat" placeholder="例：15" type="number"/>
<label>ピーキング期間</label>
<select id="days">
<option value="0">ピーキングなし</option>
<option value="3">3日間</option>
<option value="5">5日間</option>
<option selected="" value="7">7日間</option>
<option value="10">10日間</option>
</select>
<label>水分感受性</label>
<select id="waterSensitivity">
<option value="low">低</option>
<option selected="" value="medium">中</option>
<option value="high">高</option>
</select>
<label>塩分感受性</label>
<select id="saltSensitivity">
<option value="low">低</option>
<option selected="" value="medium">中</option>
<option value="high">高</option>
</select>
<label>カーボ感受性</label>
<select id="carbSensitivity">
<option value="low">低</option>
<option selected="" value="medium">中</option>
<option value="high">高</option>
</select>
<h2>1日のPFC目標（g）</h2>
<label>タンパク質（P）</label>
<label>食事回数（回）</label>
<select id="mealCount">
<option value="3">3回</option>
<option value="4">4回</option>
<option selected="" value="5">5回</option>
<option value="6">6回</option>
</select>
<input id="protein" placeholder="例：150" type="number"/>
<label>脂質（F）</label>
<input id="fat" placeholder="例：50" type="number"/>
<label>炭水化物（C）</label>
<input id="carb" placeholder="例：250" type="number"/>
<button onclick="generateStrategy()">戦略を表示</button><div id="mealPlanOutput"><h2>当日の食事タイミングと内容</h2></div>
<div id="adjustSummary"></div><div id="output"></div><div id="timelineOutput"></div>
<div id="timeScheduleSection">
<h2>大会当日のタイムスケジュール</h2>
<label>起床時間</label><input id="wakeTime" type="time"/>
<label>朝食時間</label><input id="breakfastTime" type="time"/>
<label>ステージ開始時間</label><input id="stageTime" type="time"/><label>パンプアップ開始時間</label><input id="pumpTime" type="time"/>
</div>
</div>
<script>
function formatTime(date) {
  return date.toTimeString().slice(0, 5);
}

function generateMealPlan() {
  const protein = parseInt(document.getElementById("protein").value);
  const fat = parseInt(document.getElementById("fat").value);
  const carb = parseInt(document.getElementById("carb").value);
  const meals = parseInt(document.getElementById("mealCount").value);

  const wake = document.getElementById("wakeTime").value;
  const pump = document.getElementById("pumpTime").value;
  const stage = document.getElementById("stageTime").value;

  if (!protein || !fat || !carb || !wake || !pump || !stage || isNaN(meals)) {
    document.getElementById("mealPlanOutput").innerHTML = "<p>PFC目標、食事回数、起床時間、パンプ時間、ステージ時間をすべて入力してください。</p>";
    return;
  }

  const [startH, startM] = wake.split(":").map(Number);
  const [pumpH, pumpM] = pump.split(":").map(Number);
  const [stageH, stageM] = stage.split(":").map(Number);
  const weight = parseFloat(document.getElementById("weight").value);
  const carbDose = Math.round(weight * 0.5);  // g
  const caffeineDose = Math.min(Math.round(weight * 3), 400);  // mg

  const startTime = new Date(0, 0, 0, startH, startM);
  const pumpTime = new Date(0, 0, 0, pumpH, pumpM);
  const stageTime = new Date(0, 0, 0, stageH, stageM);

  const mealDuration = (pumpTime - startTime) / 60000;
  const interval = Math.floor(mealDuration / (meals - 1));

  let current = new Date(startTime);
  let html = "<ul>";
  for (let i = 0; i < meals - 2; i++) {
    const timeStr = formatTime(current);
    const pShare = Math.round(protein / meals);
    const fShare = Math.round(fat / meals);
    const cShare = Math.round(carb / meals);
    html += `<li>${timeStr}：通常食 P${pShare}g / F${fShare}g / C${cShare}g</li>`;
    current.setMinutes(current.getMinutes() + interval);
  }

  // Add pump-specific meals
  const pump30 = new Date(pumpTime.getTime() - 30 * 60000);
  const pump15 = new Date(pumpTime.getTime() - 15 * 60000);
  html += `<li>${formatTime(pump30)}：パンプ30分前 - ジャムパン（C${carbDose}g）、塩タブレット</li>`;
  html += `<li>${formatTime(pump15)}：パンプ15分前 - カフェイン（${caffeineDose}mg）＋水200ml</li>`;
  html += `<li>${formatTime(pumpTime)}：パンプアップ開始（ステージの約1時間以内が目安）</li>`;
  html += `<li>${formatTime(stageTime)}：ステージ - 直前補給完了</li>`;
  html += "</ul>";

  html += `<p><strong>合計PFC：</strong> P${protein}g / F${fat}g / C${carb}g</p>`;
  document.getElementById("mealPlanOutput").innerHTML = html;
}

// Final integration
const prevGenerateStrategy = generateStrategy;
generateStrategy = function() {
  prevGenerateStrategy();
  generateTimeline();
  generateMealPlan();
}

document.getElementById("stageTime").addEventListener("change", () => {
  const val = document.getElementById("stageTime").value;
  if (val) {
    const [h, m] = val.split(":").map(Number);
    const stageDate = new Date(0, 0, 0, h, m);
    stageDate.setMinutes(stageDate.getMinutes() - 60);
    const formatted = stageDate.toTimeString().slice(0, 5);
    document.getElementById("pumpTime").value = formatted;
  }
});

// ※パンプはステージの約60分以内に開始するのが理想です。

function updatePFCfromTDEE() {
  const tdee = parseFloat(document.getElementById("tdee").value);
  if (!isNaN(tdee)) {
    document.getElementById("protein").value = Math.round(tdee * 0.3 / 4);
    document.getElementById("fat").value = Math.round(tdee * 0.2 / 9);
    document.getElementById("carb").value = Math.round(tdee * 0.5 / 4);
  }
}
</script></body>
</html>
