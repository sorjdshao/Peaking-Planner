<!-- Peaking Strategy UI（改善反映済み） -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ピーキング戦略（前日まで）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; background: #f4f4f4; padding: 20px; }
    .container { background: #fff; padding: 20px; border-radius: 10px; max-width: 900px; margin: auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 20px; padding: 10px; font-size: 1em; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background-color: #eee; }
    .day-block { margin-bottom: 40px; }
    @media print {
      button { display: none; }
      body { -webkit-print-color-adjust: exact; }
      table { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ピーキング戦略（前日まで）</h1>

  <label>体重（kg）</label>
  <input id="weight" type="number" placeholder="例：70" />

  <label>体脂肪率（％）</label>
  <input id="bodyfat" type="number" placeholder="例：15" />

  <label>TDEE（1日の消費カロリー）</label>
  <input id="tdee" type="number" placeholder="例：2500" />

  <label>ピーキング期間</label>
  <select id="days">
    <option value="3">3日間</option>
    <option value="5">5日間</option>
    <option value="7" selected>7日間</option>
  </select>

  <label>食事回数</label>
  <select id="mealCount">
    <option value="3">3回</option>
    <option value="4">4回</option>
    <option value="5" selected>5回</option>
    <option value="6">6回</option>
  </select>

  <label>起床時間</label>
  <input id="wakeTime" type="time" />

  <label>水分感受性</label>
  <select id="waterSensitivity">
    <option value="low">低</option>
    <option value="medium" selected>中</option>
    <option value="high">高</option>
  </select>

  <label>塩分感受性</label>
  <select id="saltSensitivity">
    <option value="low">低</option>
    <option value="medium" selected>中</option>
    <option value="high">高</option>
  </select>

  <label><input type="checkbox" id="useWaterCut" checked> 水抜きを行う</label>
  <label><input type="checkbox" id="useSaltControl" checked> 塩分調整を行う</label>

  <label>カロリー戦略（ディプリート時）</label>
  <select id="calorieStrategy">
    <option value="adjust" selected>カロリーを減らす</option>
    <option value="maintain_p">カロリー維持（Pで補う）</option>
    <option value="maintain_f">カロリー維持（Fで補う）</option>
    <option value="maintain_p_strong">カロリー維持（P多め）</option>
    <option value="maintain_f_strong">カロリー維持（F多め）</option>
  </select>

  <button onclick="displayFullSchedule()">全日スケジュールを表示</button>
  <div id="output"></div>
</div>

<script>
function displayFullSchedule() {
  const weight = parseFloat(document.getElementById("weight").value);
  const bodyfat = parseFloat(document.getElementById("bodyfat").value);
  const leanWeight = weight * (1 - bodyfat / 100);
  const tdee = parseFloat(document.getElementById("tdee").value);
  const meals = parseInt(document.getElementById("mealCount").value);
  const wake = document.getElementById("wakeTime").value;
  const [wakeH, wakeM] = wake.split(":").map(Number);
  const days = parseInt(document.getElementById("days").value);
  const waterSens = document.getElementById("waterSensitivity").value;
  const saltSens = document.getElementById("saltSensitivity").value;
  const useWaterCut = document.getElementById("useWaterCut").checked;
  const useSaltControl = document.getElementById("useSaltControl").checked;
  const calorieStrategy = document.getElementById("calorieStrategy").value;
  const output = document.getElementById("output");

  const depleteTdeeRatios = {
    3: [0.8, 0.6, 1.2],
    5: [0.8, 0.7, 0.6, 1.0, 1.2],
    7: [0.9, 0.8, 0.7, 0.6, 1.0, 1.1, 1.2]
  };

  const defaultTdeeRatios = {
    3: [1.0, 1.0, 1.0],
    5: [1.0, 1.0, 1.0, 1.0, 1.0],
    7: [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0]
  };

  const isDeplete = true; // 前日まで前提で固定
  const ratios = (calorieStrategy === "adjust") ? depleteTdeeRatios[days] : defaultTdeeRatios[days];

  const adjust = (base, sens) => {
    const factorMap = { low: 1.2, medium: 1.0, high: 0.8 };
    return Math.max(base * (factorMap[sens] || 1.0), 0);
  };

  output.innerHTML = "";
  const interval = Math.floor((14 * 60) / (meals - 1));

  ratios.forEach((rate, i) => {
    let calories = Math.round(rate * tdee);

    const baseProtein = Math.round(leanWeight * 2.3);
    const proteinKcal = baseProtein * 4;
    const fatMin = 30;
    const fatKcal = fatMin * 9;
    const remainingKcal = calories - proteinKcal - fatKcal;

    let extraProtein = 0;
    let extraFat = 0;

    if (calorieStrategy.startsWith("maintain")) {
      switch (calorieStrategy) {
        case "maintain_p":
          extraProtein = Math.round(remainingKcal / 4);
          break;
        case "maintain_f":
          extraFat = Math.round(remainingKcal / 9);
          break;
        case "maintain_p_strong":
          extraProtein = Math.round((remainingKcal * 0.7) / 4);
          extraFat = Math.round((remainingKcal * 0.3) / 9);
          break;
        case "maintain_f_strong":
          extraProtein = Math.round((remainingKcal * 0.3) / 4);
          extraFat = Math.round((remainingKcal * 0.7) / 9);
          break;
      }
    }

    const totalProtein = baseProtein + extraProtein;
    const totalFat = fatMin + extraFat;
    const pMeal = Math.round(totalProtein / meals);
    const fMeal = Math.round(totalFat / meals);

    const cTotal = Math.round((calories - (totalProtein * 4 + totalFat * 9)) / 4);
    const cPerMealWeights = Array.from({ length: meals }, (_, m) => m < meals / 2 ? 0.8 : 1.2);
    const cWeightSum = cPerMealWeights.reduce((a, b) => a + b, 0);
    const cMealArray = cPerMealWeights.map(w => Math.round(cTotal * w / cWeightSum));

    const baseWater = useWaterCut ? Math.max(weight * 0.08 - i * 0.5, 1.5) : 4;
    const baseSalt = useSaltControl ? Math.max(weight * 0.2 - i * 2, 2) : 8;
    const water = adjust(baseWater, waterSens).toFixed(1);
    const salt = Math.round(adjust(baseSalt, saltSens));

    let time = new Date(0, 0, 0, wakeH, wakeM);
    let rows = "";

    for (let m = 0; m < meals; m++) {
      const t = time.toTimeString().slice(0, 5);
      rows += `<tr><td>${t}</td><td>食事${m + 1}</td><td>${pMeal}g</td><td>${fMeal}g</td><td>${cMealArray[m]}g</td></tr>`;
      time.setMinutes(time.getMinutes() + interval);
    }

    output.innerHTML += `
      <div class="day-block">
        <h3>Day ${i + 1}（${calories} kcal / 水分 ${water}L / 塩分 ${salt}g）</h3>
        <table>
          <thead><tr><th>時間</th><th>内容</th><th>P</th><th>F</th><th>C</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  });
}
</script>

</body>
</html>